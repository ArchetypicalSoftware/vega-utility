name: Monthly Docker Build

on:
  schedule:
    - cron: '0 0 1 * *' # Runs at midnight on the first day of every month

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Log in to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Run PowerShell script to get versions
      run: |
        $versions = & ./get-versions.ps1
        $versions | ForEach-Object {
          docker build --build-arg K8SVersion=$_ -t archetypicalsoftware/vega-utility:$_ .
          docker push archetypicalsoftware/vega-utility:$_
        }
      shell: pwsh